<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Storage;
use App\Models\CertificadoFIC;
use App\Models\Empresa;
use Barryvdh\DomPDF\Facade\Pdf;

class WhatsAppController extends Controller
{
    // Verificar el webhook (requerido por Meta)
    public function verifyWebhook(Request $request)
    {
        \Log::info('=== VERIFY WEBHOOK INICIADO ===');
        \Log::info('Query parameters:', $request->query());
        
        $mode = $request->query('hub_mode');
        $token = $request->query('hub_verify_token');
        $challenge = $request->query('hub_challenge');
        
        $expectedToken = config('services.whatsapp.verify_token');
        

        // Verifica que coincida con tu verify token
        if ($mode === 'subscribe' && $token === $expectedToken) {
            \Log::info('âœ… Webhook verificado exitosamente');
            return response($challenge, 200);
        }

        \Log::warning('âŒ Webhook verification failed');
        return response('Forbidden', 403);
    }

    // Recibir mensajes de WhatsApp
    public function webhook(Request $request)
    {
        \Log::info('=== WEBHOOK INICIADO ===');
        \Log::info('Headers:', $request->headers->all());
        \Log::info('Webhook data recibida:', $request->all());

        $data = $request->all();

        // Verificar que es un mensaje vÃ¡lido
        if (isset($data['entry'][0]['changes'][0]['value']['messages'][0])) {
            $message = $data['entry'][0]['changes'][0]['value']['messages'][0];
            $rawFrom = $message['from'] ?? '';
            $normalizedPhone = preg_replace('/\D+/', '', $rawFrom); 
            $userPhone = $normalizedPhone;
            $messageText = $message['text']['body'] ?? '';
            
            \Log::info("ğŸ“± Mensaje recibido - De: {$userPhone}, Texto: {$messageText}");
            \Log::info("ğŸ“‹ Detalles del mensaje:", $message);

            // Procesar el mensaje
            $this->processMessage($userPhone, $messageText);
        } else {
            \Log::warning('âŒ No se encontrÃ³ mensaje en el webhook');
            \Log::info('Estructura completa recibida:', $data);
        }

        \Log::info('=== WEBHOOK FINALIZADO ===');
        return response('Mensaje enviado', 200);
    }

    private function processMessage($userPhone, $messageText)
    {
        \Log::info("=== PROCESS MESSAGE INICIADO ===");
        \Log::info("Procesando mensaje - Usuario: {$userPhone}, Texto: {$messageText}");

    $testNumbers = [
        '16315551181', // NÃºmero de prueba de Meta
        '16505551111', // Otro nÃºmero de prueba comÃºn
    ];
    
    if (in_array($userPhone, $testNumbers)) {
        \Log::info("ğŸ”§ Ignorando mensaje de prueba de Meta: {$userPhone}");
        return; // No responder a nÃºmeros de prueba
    }
        
        $raw = trim($messageText);
        $messageLower = strtolower($raw);

        // Obtener o inicializar el estado del usuario
        $userState = $this->getUserState($userPhone);
        \Log::info("Estado actual del usuario:", $userState);

        // --- 1) Si hay un estado activo relacionado con AUTENTICACIÃ“N, procesarlo primero ---
        $authSteps = [
            'awaiting_username',
            'awaiting_password'
        ];
        if (!empty($userState['step']) && in_array($userState['step'], $authSteps)) {
            \Log::info("Estado de autenticaciÃ³n detectado ({$userState['step']}) â€” manejando por flujo de auth");
            $this->handleAuthFlow($userPhone, $messageText, $userState);
            \Log::info("=== PROCESS MESSAGE FINALIZADO (por auth flow) ===");
            return;
        }

        // --- 2) Si hay un estado activo relacionado con flujo de certificado, procesarlo ---
        $certificateSteps = [
            'choosing_certificate_type',
            'awaiting_nit_ticket',
            'awaiting_ticket',
            'awaiting_nit_general',
            'awaiting_nit_vigencia',
            'awaiting_year'
        ];
        if (!empty($userState['step']) && in_array($userState['step'], $certificateSteps)) {
            \Log::info("Estado activo detectado ({$userState['step']}) â€” manejando por flujo de certificado");
            $this->handleCertificateFlow($userPhone, $messageLower, $userState);
            \Log::info("=== PROCESS MESSAGE FINALIZADO (por flujo activo) ===");
            return;
        }

        // --- 3) Handlers generales (sin nÃºmeros) ---
        // Saludos / menÃº
        if (str_contains($messageLower, 'hola') || $messageLower === 'inicio' || $messageLower === 'menu') {
            \Log::info("ğŸ¤– Enviando mensaje de bienvenida");
            $this->sendWelcomeMessage($userPhone);
            $this->updateUserState($userPhone, ['step' => 'main_menu']);
            return;
        }

        // Generar certificado (inicio del flujo) - detecta palabras, no nÃºmeros
        if (str_contains($messageLower, 'generar certificado') || $messageLower === 'generar' || str_contains($messageLower, 'certificado')) {
            \Log::info("ğŸ¤– Usuario solicitÃ³ iniciar flujo de Generar Certificado");
            $this->startAuthentication($userPhone);
            return;
        }

        // Requisitos
        if (str_contains($messageLower, 'requisitos')) {
            \Log::info("ğŸ¤– Usuario solicitÃ³ Requisitos");
            $this->sendRequirements($userPhone);
            return;
        }

        // Soporte
        if (str_contains($messageLower, 'soporte') || str_contains($messageLower, 'ayuda') || str_contains($messageLower, 'contacto')) {
            \Log::info("ğŸ¤– Usuario solicitÃ³ Soporte");
            $this->sendSupportInfo($userPhone);
            return;
        }

        // Registro
        if (str_contains($messageLower, 'registro') || str_contains($messageLower, 'registrarse')) {
            \Log::info("ğŸ¤– Usuario solicitÃ³ informaciÃ³n de registro");
            $this->sendRegistrationInfo($userPhone);
            return;
        }

        // Si no cae en nada, enviar sugerencia
        \Log::info("â“ No se reconociÃ³ comando global, enviando ayuda corta");
        $this->sendMessage($userPhone, "No entendÃ­ ğŸ¤”. Puedes escribir: *Generar Certificado*, *Requisitos*, *Soporte* o *Registro*.");
        \Log::info("=== PROCESS MESSAGE FINALIZADO ===");
    }

    /**
     * Manejar flujo de autenticaciÃ³n
     */
    private function handleAuthFlow($userPhone, $messageText, $userState)
    {
        \Log::info("=== HANDLE AUTH FLOW INICIADO ===");
        \Log::info("Paso actual: " . ($userState['step'] ?? 'none'));
        \Log::info("Mensaje: {$messageText}");

        $step = $userState['step'] ?? '';

        switch ($step) {
            case 'awaiting_username':
                \Log::info("ğŸ‘¤ Usuario ingresando username: {$messageText}");
                $this->processUsername($userPhone, $messageText);
                break;

            case 'awaiting_password':
                \Log::info("ğŸ” Usuario ingresando password");
                $this->processPassword($userPhone, $messageText);
                break;

            default:
                \Log::info("ğŸ”€ Estado de auth no reconocido, reiniciando");
                $this->startAuthentication($userPhone);
                break;
        }

        \Log::info("=== HANDLE AUTH FLOW FINALIZADO ===");
    }

    /**
     * Iniciar proceso de autenticaciÃ³n
     */
    private function startAuthentication($userPhone)
    {
        \Log::info("ğŸ” Iniciando autenticaciÃ³n para usuario: {$userPhone}");
        
        $message = "ğŸ” *VALIDACIÃ“N DE USUARIO*\n\n";
        $message .= "âš ï¸ *Debes validar tu informaciÃ³n antes de generar un certificado.*\n\n";
        $message .= "Por favor, ingresa tu *USUARIO*:";
        
        $this->sendMessage($userPhone, $message);
        $this->updateUserState($userPhone, ['step' => 'awaiting_username']);
    }

    /**
     * Procesar nombre de usuario
     */
    private function processUsername($userPhone, $username)
    {
        \Log::info("ğŸ” Buscando usuario en BD: {$username}");
        
        // Buscar si el usuario existe
        $empresa = Empresa::buscarPorUsuario($username);
        
        if (!$empresa) {
            \Log::warning("âŒ Usuario no encontrado: {$username}");
            $message = "âŒ *USUARIO NO REGISTRADO*\n\n";
            $message .= "No tienes usuario registrado con nosotros.\n\n";
            $message .= "Por favor, *regÃ­strate* y vuelve aquÃ­!\n\n";
            $message .= "Escribe *REGISTRO* para ver informaciÃ³n de registro o *MENU* para volver al inicio.";
            
            $this->sendMessage($userPhone, $message);
            $this->clearUserState($userPhone);
            return;
        }
        
        \Log::info("âœ… Usuario encontrado: " . $empresa->representante_legal);
        
        // Usuario existe, pedir contraseÃ±a
        $message = "âœ… Usuario encontrado.\n\n";
        $message .= "ğŸ‘¤ *" . $empresa->representante_legal . "*\n\n";
        $message .= "Ahora ingresa tu *CONTRASEÃ‘A*:";
        
        $this->sendMessage($userPhone, $message);
        $this->updateUserState($userPhone, [
            'step' => 'awaiting_password',
            'username' => $username,
            'empresa_id' => $empresa->id,
            'nit' => $empresa->nit
        ]);
    }

    /**
     * Procesar contraseÃ±a
     */
    private function processPassword($userPhone, $password)
    {
        $userState = $this->getUserState($userPhone);
        $username = $userState['username'] ?? null;
        
        if (!$username) {
            \Log::error("âŒ No se encontrÃ³ username en el estado");
            $this->sendMessage($userPhone, "âŒ Error en la autenticaciÃ³n. Por favor, inicia nuevamente.");
            $this->clearUserState($userPhone);
            return;
        }
        
        \Log::info("ğŸ” Validando contraseÃ±a para usuario: {$username}");
        
        $empresa = Empresa::buscarPorUsuario($username);
        
        if (!$empresa) {
            \Log::error("âŒ Empresa no encontrada para usuario: {$username}");
            $this->sendMessage($userPhone, "âŒ Error en la autenticaciÃ³n. Por favor, inicia nuevamente.");
            $this->clearUserState($userPhone);
            return;
        }
        
        if (!$empresa->verificarContraseÃ±a($password)) {
            \Log::warning("âŒ ContraseÃ±a incorrecta para usuario: {$username}");
            $message = "âŒ *CONTRASEÃ‘A INCORRECTA*\n\n";
            $message .= "La contraseÃ±a ingresada no es correcta.\n\n";
            $message .= "Por favor, vuelve a ingresar tu *USUARIO* o escribe *MENU* para volver al inicio.";
            
            $this->sendMessage($userPhone, $message);
            $this->updateUserState($userPhone, [
                'step' => 'awaiting_username',
                'username' => null
            ]);
            return;
        }
        
        \Log::info("âœ… AutenticaciÃ³n exitosa para: " . $empresa->representante_legal);
        
        // AutenticaciÃ³n exitosa
        $message = "âœ… *AUTENTICACIÃ“N EXITOSA*\n\n";
        $message .= "Bienvenido *{$empresa->representante_legal}*\n";
        $message .= "ğŸ“„ NIT: *{$empresa->nit}*\n\n";
        $message .= "Ahora puedes generar tu certificado.\n\n";
        
        $this->sendMessage($userPhone, $message);
        
        // Proceder con las opciones de certificado
        $this->sendCertificateOptions($userPhone);
        $this->updateUserState($userPhone, [
            'step' => 'choosing_certificate_type',
            'authenticated' => true,
            'empresa_nit' => $empresa->nit,
            'representante_legal' => $empresa->representante_legal
        ]);
    }

    private function handleCertificateFlow($userPhone, $messageText, $userState)
    {
        \Log::info("=== HANDLE CERTIFICATE FLOW INICIADO ===");
        \Log::info("Paso actual: " . ($userState['step'] ?? 'none'));
        \Log::info("Mensaje: {$messageText}");

        $step = $userState['step'] ?? '';

        // Verificar si estÃ¡ autenticado para generar certificados
        if (!isset($userState['authenticated']) || !$userState['authenticated']) {
            \Log::warning("âŒ Usuario no autenticado intentando generar certificado");
            $this->sendMessage($userPhone, "âŒ Debes autenticarte primero para generar certificados.");
            $this->startAuthentication($userPhone);
            return;
        }

        $nit = $userState['empresa_nit'] ?? null;
        if (!$nit) {
            \Log::error("âŒ No se encontrÃ³ NIT en el estado del usuario autenticado");
            $this->sendMessage($userPhone, "âŒ Error: No se encontrÃ³ informaciÃ³n de la empresa. Por favor, autentÃ­cate nuevamente.");
            $this->startAuthentication($userPhone);
            return;
        }

        switch ($step) {
            case 'choosing_certificate_type':
                \Log::info("ğŸ”€ Usuario eligiendo tipo de certificado (por texto)");
                if (str_contains($messageText, 'ticket')) {
                    \Log::info("ğŸ« Usuario seleccionÃ³ Ticket");
                    $this->updateUserState($userPhone, [
                        'step' => 'awaiting_ticket',
                        'type' => 'ticket'
                    ]);
                    $this->sendMessage($userPhone, "ğŸ« *Certificado por TICKET*\n\nPor favor ingresa el nÃºmero de *TICKET*:");
                } elseif (str_contains($messageText, 'nit') && !str_contains($messageText, 'vigencia')) {
                    \Log::info("ğŸ¢ Usuario seleccionÃ³ NIT - Generando certificado general");
                    // Generar certificado general directamente con el NIT autenticado
                    $this->generateAndSendCertificate($userPhone, 'nit_general', [
                        'nit' => $nit
                    ]);
                } elseif (str_contains($messageText, 'vigencia') || str_contains($messageText, 'vigente')) {
                    \Log::info("ğŸ“… Usuario seleccionÃ³ Vigencia");
                    $this->updateUserState($userPhone, [
                        'step' => 'awaiting_year',
                        'type' => 'vigencia'
                    ]);
                    $this->sendMessage($userPhone, "ğŸ“… *Certificado por VIGENCIA*\n\nIngresa el *AÃ‘O* de la vigencia (ejemplo: 2025). Solo se permiten 15 aÃ±os atrÃ¡s desde el actual.");
                } else {
                    \Log::info("âŒ OpciÃ³n no reconocida en choosing_certificate_type, reenviando instrucciones");
                    $this->sendMessage($userPhone, "No reconocÃ­ la opciÃ³n. Responde con *TICKET*, *NIT* o *VIGENCIA* segÃºn corresponda.");
                }
                break;

            case 'awaiting_ticket':
                \Log::info("ğŸŸï¸ Usuario ingresando ticket: {$messageText}");
                $this->generateAndSendCertificate($userPhone, 'nit_ticket', [
                    'nit' => $nit,
                    'ticket' => $messageText
                ]);
                break;

            case 'awaiting_year':
                \Log::info("ğŸ“… Usuario ingresando aÃ±o: {$messageText}");
                $year = intval(preg_replace('/[^0-9]/','',$messageText));
                $currentYear = date('Y');

                if ($year <= 0 || $year > $currentYear || $year < ($currentYear - 15)) {
                    \Log::warning("âŒ AÃ±o fuera de rango: {$year}");
                    $this->sendMessage($userPhone, "âŒ *AÃ±o fuera de rango*\n\nSolo se permiten vigencias entre " . ($currentYear - 15) . " y $currentYear . Por favor ingresa un aÃ±o vÃ¡lido (ej: 2025).");
                    return;
                }

                $this->generateAndSendCertificate($userPhone, 'nit_vigencia', [
                    'nit' => $nit,
                    'vigencia' => $year
                ]);
                break;

            default:
                \Log::info("ğŸ”€ Estado no reconocido, enviando mensaje de bienvenida");
                $this->sendWelcomeMessage($userPhone);
                break;
        }

        \Log::info("=== HANDLE CERTIFICATE FLOW FINALIZADO ===");
    }

    private function generateAndSendCertificate($userPhone, $type, $data)
    {
        \Log::info("=== GENERATE AND SEND CERTIFICATE INICIADO ===");
        \Log::info("Tipo: {$type}, Datos:", $data);

        try {
            $this->sendMessage($userPhone, "â³ *Generando certificado...*\n\nPor favor espera unos segundos.");

            // Buscar certificados
            $certificados = $this->buscarCertificados($type, $data['nit'], $data['ticket'] ?? null, $data['vigencia'] ?? null);
            \Log::info("Certificados encontrados: " . $certificados->count());

            if ($certificados->isEmpty()) {
                \Log::warning("âŒ No se encontraron certificados para los criterios");
                $this->sendMessage($userPhone, "âŒ *No se encontraron certificados*\n\nNo hay certificados con los criterios especificados.");
                $this->clearUserState($userPhone);
                return;
            }

            // Generar PDF
            \Log::info("ğŸ“„ Generando PDF...");
            $pdfPath = $this->generarPdf($certificados, $type);
            \Log::info("PDF generado en: {$pdfPath}");

            // Enviar PDF por WhatsApp
            \Log::info("ğŸ“¤ Enviando documento por WhatsApp...");
            $this->sendDocument($userPhone, $pdfPath, $this->generarNombreArchivo($certificados->first(), $type));

            $this->sendMessage($userPhone, "âœ… *Certificado generado exitosamente!*\n\nTu certificado FIC ha sido generado y enviado.");
            
            // Ofrecer volver al menÃº
            $this->sendMessage($userPhone, "Â¿Necesitas algo mÃ¡s? Escribe *MENU* para ver las opciones.");

            // Limpiar estado pero mantener autenticaciÃ³n
            $userState = $this->getUserState($userPhone);
            $this->updateUserState($userPhone, [
                'step' => 'main_menu',
                'authenticated' => true,
                'empresa_nit' => $userState['empresa_nit'] ?? null,
                'representante_legal' => $userState['representante_legal'] ?? null
            ]);

        } catch (\Exception $e) {
            \Log::error('âŒ Error generando certificado WhatsApp: ' . $e->getMessage());
            \Log::error('Stack trace: ' . $e->getTraceAsString());
            $this->sendMessage($userPhone, "âŒ *Error del sistema*\n\nPor favor intenta nuevamente o contacta a soporte.");
            $this->clearUserState($userPhone);
        }
        
        \Log::info("=== GENERATE AND SEND CERTIFICATE FINALIZADO ===");
    }

    // MÃ©todos auxiliares existentes (mantener igual)
    private function buscarCertificados($tipo, $nit, $ticket = null, $vigencia = null)
    {
        \Log::info("ğŸ” Buscando certificados - Tipo: {$tipo}, NIT: {$nit}, Ticket: {$ticket}, Vigencia: {$vigencia}");
        
        $query = CertificadoFIC::where('constructor_nit', $nit);
        \Log::info("Query base construida, count: " . $query->count());
        
        switch ($tipo) {
            case 'nit_ticket':
                $result = $query->where('ticket', $ticket)->get();
                \Log::info("Resultado busqueda por ticket: " . $result->count());
                return $result;
            case 'nit_vigencia':
                $pattern = $vigencia . '-%';
                $result = $query->where('periodo', 'like', $pattern)->get();
                \Log::info("Resultado busqueda por vigencia {$pattern}: " . $result->count());
                return $result;
            case 'nit_general':
            default:
                $result = $query->get();
                \Log::info("Resultado busqueda general: " . $result->count());
                return $result;
        }
    }

    private function generarPdf($certificados, $tipo)
    {
        \Log::info("ğŸ“Š Generando PDF para {$certificados->count()} certificados, tipo: {$tipo}");
        
        $constructor = $certificados->first();
        $total = $certificados->sum('valor_pago');
        
        \Log::info("Constructor: {$constructor->constructor_razon_social}, Total: {$total}");
        
        $datos = [
            'certificados' => $certificados,
            'constructor' => $constructor,
            'total' => $total,
            'fecha_emision' => now(),
            'tipo_busqueda' => $tipo
        ];
        
        $pdf = Pdf::loadView('certificados.plantilla', $datos)
                  ->setPaper('a4', 'portrait')
                  ->setOptions([
                      'defaultFont' => 'Arial',
                      'isHtml5ParserEnabled' => true,
                      'isRemoteEnabled' => true
                  ]);
        
        // Guardar temporalmente
        $fileName = $this->generarNombreArchivo($constructor, $tipo);
        $filePath = storage_path('app/temp/' . $fileName);
        
        \Log::info("Guardando PDF en: {$filePath}");
        
        // Asegurar que existe el directorio
        if (!file_exists(dirname($filePath))) {
            \Log::info("Creando directorio: " . dirname($filePath));
            mkdir(dirname($filePath), 0755, true);
        }
        
        $pdf->save($filePath);
        \Log::info("âœ… PDF guardado exitosamente");
        
        return $filePath;
    }

    private function generarNombreArchivo($constructor, $tipo)
    {
        $fecha = now()->format('Y-m-d');
        $nit = $constructor->constructor_nit;
        $fileName = "Certificado_FIC_{$nit}_{$tipo}_{$fecha}.pdf";
        \Log::info("Nombre de archivo generado: {$fileName}");
        return $fileName;
    }

    // Mensajes predefinidos
    private function sendWelcomeMessage($userPhone)
    {
        \Log::info("ğŸ‘‹ Enviando mensaje de bienvenida a {$userPhone}");
        $message = "ğŸ‘‹ *Bienvenido al Chatbot FIC - SENA*\n\n";
        $message .= "Opciones disponibles (escribe el nombre de la opciÃ³n):\n\n";
        $message .= "â€¢ *Generar Certificado* - Para iniciar la creaciÃ³n de certificados\n";
        $message .= "â€¢ *Requisitos* - InformaciÃ³n necesaria\n";
        $message .= "â€¢ *Soporte* - Contacto de asistencia\n";
        $message .= "â€¢ *Registro* - InformaciÃ³n para registrarse\n\n";
        $message .= "Ejemplo: escribe *Generar Certificado* para empezar.";

        $this->sendMessage($userPhone, $message);
    }

    private function sendCertificateOptions($userPhone)
    {
        \Log::info("ğŸ“„ Enviando opciones de certificado a {$userPhone}");
        $message = "ğŸ“„ *GENERAR CERTIFICADO FIC*\n\n";
        $message .= "Por favor indica el *tipo* de certificado escribiendo su nombre:\n\n";
        $message .= "â€¢ *TICKET* - Certificado especÃ­fico por nÃºmero de ticket\n";
        $message .= "â€¢ *NIT* - Todos los certificados asociados a tu NIT\n";
        $message .= "â€¢ *VIGENCIA* - Certificado filtrado por aÃ±o de vigencia\n\n";
        $message .= "Ejemplo: responde *NIT* para buscar todos tus certificados.";

        $this->sendMessage($userPhone, $message);
    }

    private function sendRequirements($userPhone)
    {
        \Log::info("ğŸ“‹ Enviando requisitos a {$userPhone}");
        $message = "ğŸ“‹ *REQUISITOS PARA CERTIFICADOS FIC*\n\n";
        $message .= "â€¢ NIT o CÃ©dula del empresario\n";
        $message .= "â€¢ Tipo de certificado (Ticket, NIT o Vigencia)\n";
        $message .= "â€¢ Para vigencia: aÃ±o especÃ­fico (mÃ¡x. 15 aÃ±os atrÃ¡s)\n\n";
        $message .= "Escribe *MENU* para volver al inicio.";

        $this->sendMessage($userPhone, $message);
    }

    private function sendSupportInfo($userPhone)
    {
        \Log::info("ğŸ“ Enviando info de soporte a {$userPhone}");
        $message = "ğŸ“ *SOPORTE TÃ‰CNICO*\n\n";
        $message .= "Para asistencia tÃ©cnica contacta:\n\n";
        $message .= "ğŸ“§ Email: soporte@sena.edu.co\n";
        $message .= "ğŸŒ Web: www.sena.edu.co\n\n";
        $message .= "Escribe *MENU* para volver al inicio.";

        $this->sendMessage($userPhone, $message);
    }

    private function sendRegistrationInfo($userPhone)
    {
        \Log::info("ğŸ“ Enviando info de registro a {$userPhone}");
        $message = "ğŸ“ *REGISTRO DE NUEVO USUARIO*\n\n";
        $message .= "Para registrarte en nuestro sistema, debes ir a la pagina de oficial:\n\n";
        $message .= "ğŸŒ *Web:* www.fic.sena.edu.co/registro\n\n";
        $message .= "Escribe *MENU* para volver al inicio.";

        $this->sendMessage($userPhone, $message);
    }

    // MÃ©todos para enviar mensajes y documentos (mantener igual)
    private function sendMessage($to, $message)
    {
        \Log::info("âœ‰ï¸ ENVIANDO MENSAJE - Para: {$to}");
        \Log::info("ğŸ“ Mensaje: {$message}");
        
        $url = 'https://graph.facebook.com/v17.0/' . config('services.whatsapp.phone_number_id') . '/messages';
        \Log::info("ğŸŒ URL: {$url}");
        
        \Log::info("ğŸ”‘ Token: " . substr(config('services.whatsapp.access_token'), 0, 10) . "...");
        \Log::info("ğŸ“ Phone Number ID: " . config('services.whatsapp.phone_number_id'));

        try {
            $response = Http::withToken(config('services.whatsapp.access_token'))
                ->timeout(30)
                ->post($url, [
                    'messaging_product' => 'whatsapp',
                    'to' => $to,
                    'text' => ['body' => $message]
                ]);

            \Log::info("ğŸ“¡ Respuesta HTTP Status: " . $response->status());
            \Log::info("ğŸ“¡ Respuesta WhatsApp API:", $response->json());

            if ($response->successful()) {
                \Log::info("âœ… Mensaje enviado exitosamente a {$to}");
            } else {
                \Log::error("âŒ Error enviando mensaje: " . $response->body());
            }

        } catch (\Exception $e) {
            \Log::error("ğŸ’¥ ExcepciÃ³n enviando mensaje: " . $e->getMessage());
            \Log::error("ğŸ“‹ Stack trace: " . $e->getTraceAsString());
        }
    }

    private function sendDocument($to, $filePath, $fileName)
    {
        \Log::info("ğŸ“ ENVIANDO DOCUMENTO - Para: {$to}, Archivo: {$fileName}");
        \Log::info("ğŸ“ Ruta del archivo: {$filePath}");

        $url = 'https://graph.facebook.com/v17.0/' . config('services.whatsapp.phone_number_id') . '/messages';

        try {
            // Subir el archivo a WhatsApp
            \Log::info("â¬†ï¸ Subiendo archivo a WhatsApp...");
            $mediaResponse = Http::withToken(config('services.whatsapp.access_token'))
                ->attach('file', file_get_contents($filePath), $fileName)
                ->post('https://graph.facebook.com/v17.0/' . config('services.whatsapp.phone_number_id') . '/media', [
                    'messaging_product' => 'whatsapp',
                    'type' => 'document/pdf'
                ]);

            \Log::info("ğŸ“¡ Respuesta subida de archivo:", $mediaResponse->json());

            if (isset($mediaResponse->json()['id'])) {
                $mediaId = $mediaResponse->json()['id'];
                \Log::info("ğŸ†” Media ID obtenido: {$mediaId}");

                // Enviar el documento
                \Log::info("ğŸ“¤ Enviando documento con media ID...");
                $sendResponse = Http::withToken(config('services.whatsapp.access_token'))
                    ->post($url, [
                        'messaging_product' => 'whatsapp',
                        'to' => $to,
                        'type' => 'document',
                        'document' => [
                            'id' => $mediaId,
                            'filename' => $fileName
                        ]
                    ]);

                \Log::info("ğŸ“¡ Respuesta envÃ­o de documento:", $sendResponse->json());
                \Log::info("âœ… Documento enviado exitosamente");

            } else {
                \Log::error("âŒ No se pudo obtener media ID");
            }

        } catch (\Exception $e) {
            \Log::error("ğŸ’¥ ExcepciÃ³n enviando documento: " . $e->getMessage());
            \Log::error("ğŸ“‹ Stack trace: " . $e->getTraceAsString());
        }

        // Limpiar archivo temporal
        if (file_exists($filePath)) {
            unlink($filePath);
            \Log::info("ğŸ§¹ Archivo temporal eliminado: {$filePath}");
        }
    }

    // Manejo de estado del usuario (usando cache)
    private function getUserState($userPhone)
    {
        $state = cache("whatsapp_state_{$userPhone}") ?? [];
        \Log::info("ğŸ“ Obteniendo estado del usuario {$userPhone}:", $state);
        return $state;
    }

    private function updateUserState($userPhone, $state)
    {
        \Log::info("ğŸ“ Actualizando estado del usuario {$userPhone}:", $state);
        cache(["whatsapp_state_{$userPhone}" => array_merge($this->getUserState($userPhone), $state)]);
        \Log::info("âœ… Estado actualizado");
    }

    private function clearUserState($userPhone)
    {
        \Log::info("ğŸ§¹ Limpiando estado del usuario {$userPhone}");
        cache()->forget("whatsapp_state_{$userPhone}");
        \Log::info("âœ… Estado limpiado");
    }
}